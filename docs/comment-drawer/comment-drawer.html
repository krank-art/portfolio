<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comment Drawer</title>

  <style>
    .row-button-group {
      display: flex;
      gap: 10px;
    }

    .row-button {
      display: inline-block;
    }

    .row-button-label {
      display: inline-flex;
      padding: 10px 20px;
      border: 1px solid black;
      cursor: pointer;
      background: white;
      user-select: none;
    }

    .row-button-radio {
      display: none;
    }

    .row-button-radio:checked+.row-button-label {
      background: #ffcc00;
    }
  </style>
</head>

<body>
  <div class="row-button-group">
    <label class="row-button">
      <input class="row-button-radio" type="radio" name="tool" value="brush2" checked>
      <span class="row-button-label">Brush 2</span>
    </label>
    <label class="row-button">
      <input class="row-button-radio" type="radio" name="tool" value="brush3">
      <span class="row-button-label">Brush 3</span>
    </label>
    <label class="row-button">
      <input class="row-button-radio" type="radio" name="tool" value="brush5">
      <span class="row-button-label">Brush 5</span>
    </label>
    <label class="row-button">
      <input class="row-button-radio" type="radio" name="tool" value="brush10">
      <span class="row-button-label">Brush 10</span>
    </label>
  </div>

  <div class="row-button-group">
    <label class="row-button">
      <input class="row-button-radio" type="radio" name="tool" value="eraser3">
      <span class="row-button-label">Eraser 3</span>
    </label>
    <label class="row-button">
      <input class="row-button-radio" type="radio" name="tool" value="eraser5">
      <span class="row-button-label">Eraser 5</span>
    </label>
    <label class="row-button">
      <input class="row-button-radio" type="radio" name="tool" value="eraser7">
      <span class="row-button-label">Eraser 7</span>
    </label>
    <label class="row-button">
      <input class="row-button-radio" type="radio" name="tool" value="eraser12">
      <span class="row-button-label">Eraser 12</span>
    </label>
  </div>

  <div class="row-button-group">
    <label class="row-button">
      <input class="row-button-radio" type="radio" name="pattern" value="100%" checked>
      <span class="row-button-label">Solid</span>
    </label>
    <label class="row-button">
      <input class="row-button-radio" type="radio" name="pattern" value="75%">
      <span class="row-button-label">Pattern 75%</span>
    </label>
    <label class="row-button">
      <input class="row-button-radio" type="radio" name="pattern" value="50%">
      <span class="row-button-label">Pattern 50%</span>
    </label>
    <label class="row-button">
      <input class="row-button-radio" type="radio" name="pattern" value="25%">
      <span class="row-button-label">Pattern 25%</span>
    </label>
  </div>

  <script>
    const canvas = document.createElement("canvas");
    const scale = 4;
    canvas.width = 320 * scale;
    canvas.height = 120 * scale;
    canvas.style.border = "1px solid black";
    document.body.appendChild(canvas);

    const ctx = canvas.getContext("2d");
    let pattern = "75%";
    let drawing = false;
    let paths = [];
    let currentPath = [];
    const lastKnownPosition = { x: null, y: null };

    function drawPixelLine({ from, to, brusher = null, scale = 1 }) {
      const maxPixelDrawing = 10000;
      let x0 = Math.round(from.x), y0 = Math.round(from.y);
      let x1 = Math.round(to.x), y1 = Math.round(to.y);

      let dx = Math.abs(x1 - x0), sx = x0 < x1 ? 1 : -1;
      let dy = -Math.abs(y1 - y0), sy = y0 < y1 ? 1 : -1;
      let err = dx + dy;

      let currentPixelDrawingLimit = 0;
      while (currentPixelDrawingLimit < maxPixelDrawing) {
        brusher ? brusher(x0, y0) : drawPixel({ x: x0, y: y0, scale });
        currentPixelDrawingLimit++;
        if (x0 === x1 && y0 === y1) break;
        let e2 = 2 * err;
        if (e2 >= dy) { err += dy; x0 += sx; }
        if (e2 <= dx) { err += dx; y0 += sy; }
      }
    }

    canvas.addEventListener("mousedown", () => {
      drawing = true;
      currentPath = [];
      paths.push(currentPath);
    });

    canvas.addEventListener("mousemove", (e) => {
      const brush = (x, y) => drawSquare({ x, y, scale, size: 3, pattern });
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      const rawX = e.clientX - rect.left;
      const rawY = e.clientY - rect.top;
      const x = Math.round(rawX / scale);
      const y = Math.round(rawY / scale);
      const currentPosition = { x, y };
      currentPath.push(currentPosition);
      if (lastKnownPosition.x && lastKnownPosition.y)
        drawPixelLine({ from: lastKnownPosition, to: currentPosition, brusher: brush, scale });
      else
        brush(x, y);
      lastKnownPosition.x = currentPosition.x;
      lastKnownPosition.y = currentPosition.y;
    });

    canvas.addEventListener("mouseup", () => {
      drawing = false;
      lastKnownPosition.x = null;
      lastKnownPosition.y = null;
    });

    canvas.addEventListener("mouseleave", () => {
      drawing = false;
      lastKnownPosition.x = null;
      lastKnownPosition.y = null;
    });

    function drawPixel({ x, y, scale = 1 }) {
      ctx.fillRect(x * scale, y * scale, scale, scale);
    }

    function drawSquare({ x, y, size = 2, scale = 1, pattern = null }) {
      const centerX = x - Math.round(size / 2);
      const centerY = y - Math.round(size / 2);
      if (!pattern) {
        ctx.fillRect(centerX * scale, centerY * scale, size * scale, size * scale);
        return;
      }
      // We want to minimize the calls to 'ctx.fillRect', so depending on the pattern the iteration varies.
      if (pattern === "25%") {
        for (let i = centerX; i < centerX + size; i++)
          for (let j = centerY; j < centerY + size; j++) {
            if (i % 2 === 0 && j % 2 === 0)
              ctx.fillRect(i * scale, j * scale, 1 * scale, 1 * scale);
          }
        return;
      }
      if (pattern === "50%") {
        for (let i = centerX; i < centerX + size; i++)
          for (let j = centerY; j < centerY + size; j++) {
            if ((i + j) % 2 === 0)
              ctx.fillRect(i * scale, j * scale, 1 * scale, 1 * scale);
          }
        return;
      }
      if (pattern === "75%") {
        for (let i = centerX; i < centerX + size; i++)
          if (i % 2 === 0)
            ctx.fillRect(i * scale, centerY * scale, 1 * scale, size * scale);
        for (let j = centerY; j < centerY + size; j++)
          if (j % 2 === 0)
            ctx.fillRect(centerX * scale, j * scale, size * scale, 1 * scale);
        return;
      }
      throw new Error(`Unknown pattern '${pattern}'. `);
    }

    const undoButton = document.createElement("button");
    undoButton.textContent = "Undo";
    document.body.appendChild(undoButton);

    undoButton.addEventListener("click", () => {
      paths.pop();
      redraw();
    });

    function redraw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (const path of paths) {
        for (let i = 0; i < path.length; i++) {
          const currentPoint = path[i];
          const lastPoint = i < 0 ? null : path[i - 1];
          if (lastPoint)
            drawPixelLine({
              from: lastPoint,
              to: currentPoint,
              brusher: (x, y) => drawSquare({ x, y, scale, size: 3, pattern }),
              scale,
            });
          else
            drawSquare({ x: currentPoint.x, y: currentPoint.y, scale, size: 3, pattern });
        }
      }
    }

    const downloadButton = document.createElement("button");
    downloadButton.textContent = "Download PNG";
    document.body.appendChild(downloadButton);

    downloadButton.addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = "drawing.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    const toolRadios = Array.from(document.querySelectorAll(".row-button-radio[name='tool']"));
    for (const input of toolRadios)
      input.addEventListener("change", (event) => {
        const value = event.target.value;
        const match = value.match(/^([a-zA-Z]+).*([0-9]+)$/);
        const brushType = match[1];
        const brushSize = parseInt(match[2]);
        console.log(brushType, brushSize)
      });

    const patternRadios = Array.from(document.querySelectorAll(".row-button-radio[name='pattern']"));
    for (const input of patternRadios)
      input.addEventListener("change", (event) => {
        const value = event.target.value;
        console.log(value);
      });

  </script>
</body>

</html>